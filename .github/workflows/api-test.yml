name: API Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🛎️ Checkout Code
        uses: actions/checkout@v3
        
      - name: 📦 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      # Install dependencies for each microservice
      - name: 📥 Install dependencies for parking_zones
        run: cd parking_zones && npm ci || npm install
        
      - name: 📥 Install dependencies for OAuth
        run: cd OAuth && npm ci || npm install
        
      - name: 📥 Install dependencies for userProfile
        run: cd userProfile && npm ci || npm install
        
      - name: 📥 Install dependencies for userLocation
        run: cd userLocation && npm ci || npm install
        
      # Install dependencies for the test project (ParkIteso)
      - name: 📥 Install dependencies for tests
        run: npm ci || npm install
        
      # Start your APIs (if needed for integration tests)
      - name: 🚀 Start the API Servers
        run: |
          cd parking_zones && npm start &
          cd ../OAuth && npm start &
          cd ../userProfile && npm start &
          cd ../userLocation && npm start &
          sleep 10 # wait for APIs to start
        env:
          DATABASE_HOST: db-parkiteso2.chg3se8fdf46.us-east-1.rds.amazonaws.com
          DATABASE_USER: admin
          DATABASE_PASSWORD: admin123
          DATABASE_NAME: parkiteso
          DATABASE_PORT: 3306
          NODE_ENV: test
        
      # Run CodeceptJS tests
      - name: 🧪 Run API Tests
        run: npx codeceptjs run --steps
        env:
          DATABASE_HOST: db-parkiteso2.chg3se8fdf46.us-east-1.rds.amazonaws.com
          DATABASE_USER: admin
          DATABASE_PASSWORD: admin123
          DATABASE_NAME: parkiteso
          DATABASE_PORT: 3306
          NODE_ENV: test
