name: API Tests
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›Žï¸ Checkout Code
        uses: actions/checkout@v3
        
      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      # Create package-lock.json files first
      - name: ðŸ“„ Create package-lock files
        run: |
          cd parking_zones && npm install --package-lock-only
          cd ../OAuth && npm install --package-lock-only
          cd ../userProfile && npm install --package-lock-only
          cd ../userLocation && npm install --package-lock-only
          cd ../ && npm install --package-lock-only
          
      # Now install dependencies with clean install
      - name: ðŸ“¥ Install dependencies for parking_zones
        run: cd parking_zones && npm install
        
      - name: ðŸ“¥ Install dependencies for OAuth
        run: cd OAuth && npm install
        
      - name: ðŸ“¥ Install dependencies for userProfile
        run: cd userProfile && npm install
        
      - name: ðŸ“¥ Install dependencies for userLocation
        run: cd userLocation && npm install
        
      # Install dependencies for the test project (ParkIteso)
      - name: ðŸ“¥ Install dependencies for tests
        run: npm install
        
      # Start your APIs with proper error handling
      - name: ðŸš€ Start the API Servers
        run: |
          cd parking_zones
          npm start &
          PARKING_PID=$!
          cd ../OAuth
          npm start &
          OAUTH_PID=$!
          cd ../userProfile
          npm start &
          PROFILE_PID=$!
          cd ../userLocation
          npm start &
          LOCATION_PID=$!
          cd ..
          
          # Wait for servers to start
          echo "Waiting for servers to start..."
          sleep 15
          
          # Check if processes are running
          if ps -p $PARKING_PID > /dev/null; then
            echo "Parking zones server running"
          else
            echo "Parking zones server failed to start"
            exit 1
          fi
          if ps -p $OAUTH_PID > /dev/null; then
            echo "OAuth server running"
          else
            echo "OAuth server failed to start"
            exit 1
          fi
          if ps -p $PROFILE_PID > /dev/null; then
            echo "User profile server running"
          else
            echo "User profile server failed to start"
            exit 1
          fi
          if ps -p $LOCATION_PID > /dev/null; then
            echo "User location server running"
          else
            echo "User location server failed to start"
            exit 1
          fi
        env:
          DATABASE_HOST: db-parkiteso2.chg3se8fdf46.us-east-1.rds.amazonaws.com
          DATABASE_USER: admin
          DATABASE_PASSWORD: admin123
          DATABASE_NAME: parkiteso
          DATABASE_PORT: 3306
          NODE_ENV: test
        
      # Run CodeceptJS tests
      - name: ðŸ§ª Run API Tests
        run: npx codeceptjs run --steps
        env:
          DATABASE_HOST: db-parkiteso2.chg3se8fdf46.us-east-1.rds.amazonaws.com
          DATABASE_USER: admin
          DATABASE_PASSWORD: admin123
          DATABASE_NAME: parkiteso
          DATABASE_PORT: 3306
          NODE_ENV: test
